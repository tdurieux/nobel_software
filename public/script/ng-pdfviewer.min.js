/**
 * @preserve AngularJS PDF viewer directive using pdf.js.
 *
 * https://github.com/akrennmair/ng-pdfviewer
 *
 * MIT license
 */

angular
  .module("ngPDFViewer", [])
  .factory("RecursionHelper", [
    "$compile",
    function ($compile) {
      return {
        /**
         * Manually compiles the element, fixing the recursion loop.
         * @param element
         * @param [link] A post-link function, or an object with function(s) registered via pre and post properties.
         * @returns An object containing the linking functions.
         */
        compile: function (element, link) {
          // Normalize the link parameter
          if (angular.isFunction(link)) {
            link = { post: link };
          }

          // Break the recursion loop by removing the contents
          var contents = element.contents().remove();
          var compiledContents;
          return {
            pre: link && link.pre ? link.pre : null,
            /**
             * Compiles and re-adds the contents
             */
            post: function (scope, element) {
              // Compile the contents
              if (!compiledContents) {
                compiledContents = $compile(contents);
              }
              // Re-add the compiled contents to the element
              compiledContents(scope, function (clone) {
                element.append(clone);
              });

              // Call the post-linking function, if any
              if (link && link.post) {
                link.post.apply(null, arguments);
              }
            },
          };
        },
      };
    },
  ])
  .directive("pdfpageviewer", [
    function () {
      return {
        restrict: "E",
        template: "<canvas></canvas>",
        scope: {
          onPageLoad: "=",
          page: "=",
          pdfDoc: "=",
          scale: "=",
        },
        controller: [
          "$scope",
          "$element",
          function ($scope, $element) {
            $scope.scale = 1.0;
            const canvas = $element.find("canvas")[0];

            $scope.$watch("pdfDoc", (pdfDoc) => {
              if (pdfDoc) {
                $scope.renderPage($scope.page);
              }
            });

            $scope.renderPage = async function (num) {
              const page = await $scope.pdfDoc.getPage(num);
              const ratio =
                $element[0].clientWidth / page.getViewport(1.0).width;

              const viewport = page.getViewport(ratio);
              canvas.height = viewport.height;
              canvas.width = viewport.width;

              const ctx = canvas.getContext("2d");
              await page.render({ canvasContext: ctx, viewport: viewport });
              if ($scope.onPageLoad) {
                $scope.$apply(function () {
                  $scope.onPageLoad({
                    page: $scope.page,
                    total: $scope.pdfDoc.numPages,
                  });
                });
              }
              return true;
            };
          },
        ],
      };
    },
  ])
  .directive("pdfviewer", [
    "RecursionHelper",
    function (RecursionHelper) {
      var instance_id = null;

      return {
        restrict: "E",
        template: `<div class='alert alert-warning' role='warning' ng-show='info' ng-bind='info'></div><div class='alert alert-danger' role='alert' ng-show='error' ng-bind='error'></div>
        <div class="pdf_action">
		      <div class="scale" i18n-Tooltip="_scale_tooltip_">
          {{scale}}
            <select ng-model="scale">
              <option value="auto">Auto</option>
              <option value="0.5">50%</option>
              <option value="0.75">75%</option>
              <option value="1.0">100%</option>
              <option value="1.25">125%</option>
              <option value="1.50">150%</option>
              <option value="2">200%</option>
            </select>
          </div>
          <div class="navigation">
            <div class="prevPage icon-prev-page" ng-click="prevPage()">&nbsp;</div>
            <input type="number" max="{{pdfDoc.numPages}}" ng-model="page" ng-change="changePage(page)">
            <span>/</span>
            <div class="totalPage" ng-bind="pdfDoc.numPages"></div>
            <div class="nextPage icon-next-page" ng-click="nextPage()">&nbsp;</div>
          </div>
        </div>
        <pdfpageviewer ng-repeat='p in [].constructor(pdfDoc.numPages) track by $index' page='$index + 1' pdf-doc='pdfDoc'></pdfpageviewer>`,
        scope: {
          onPageLoad: "&",
          loadProgress: "&",
          src: "@",
          id: "=",
        },
        compile: function (element) {
          return RecursionHelper.compile(element);
        },
        controller: [
          "$scope",
          "$element",
          function ($scope, $element) {
            $scope.pdfDoc = null;
            $scope.scale = 1.0;
            $scope.error = null;
            $scope.info = null;

            $scope.documentProgress = function (progressData) {
              if ($scope.loadProgress) {
                $scope.loadProgress({
                  state: "loading",
                  loaded: progressData.loaded,
                  total: progressData.total,
                });
              }
            };

            $scope.loadPDF = function (path) {
              $scope.pdfDoc = null;
              $scope.scale = 1.0;
              $scope.error = null;
              $scope.info = "Loading";
              PDFJS.getDocument(path, null, null, $scope.documentProgress).then(
                function (_pdfDoc) {
                  $scope.$apply(() => {
                    $scope.totalPage = _pdfDoc;
                    $scope.info = null;
                    $scope.pdfDoc = _pdfDoc;
                  });
                  if ($scope.loadProgress) {
                    $scope.loadProgress({
                      state: "finished",
                      loaded: 0,
                      total: 0,
                    });
                  }
                },
                function (message, exception) {
                  $scope.info = null;
                  $scope.error = "PDF load error: " + message;
                  console.log("PDF load error: " + message);
                  if ($scope.loadProgress) {
                    $scope.loadProgress({
                      state: "error",
                      loaded: 0,
                      total: 0,
                    });
                  }
                }
              );
            };

            $scope.$on("pdfviewer.nextPage", function (evt, id) {
              if (id !== instance_id) {
                return;
              }

              if ($scope.pageNum < $scope.pdfDoc.numPages) {
                $scope.pageNum++;
                $scope.renderPage($scope.pageNum);
              }
            });

            $scope.$on("pdfviewer.prevPage", function (evt, id) {
              if (id !== instance_id) {
                return;
              }

              if ($scope.pageNum > 1) {
                $scope.pageNum--;
                $scope.renderPage($scope.pageNum);
              }
            });

            $scope.$on("pdfviewer.gotoPage", function (evt, id, page) {
              if (id !== instance_id) {
                return;
              }

              if (page >= 1 && page <= $scope.pdfDoc.numPages) {
                $scope.pageNum = page;
                $scope.renderPage($scope.pageNum);
              }
            });

            $scope.$watch("src", () => {
              $scope.loadPDF($scope.src);
            });
          },
        ],
      };
    },
  ])
  .service("PDFViewerService", [
    "$rootScope",
    function ($rootScope) {
      var svc = {};
      svc.nextPage = function () {
        $rootScope.$broadcast("pdfviewer.nextPage");
      };

      svc.prevPage = function () {
        $rootScope.$broadcast("pdfviewer.prevPage");
      };

      svc.Instance = function (id) {
        var instance_id = id;

        return {
          prevPage: function () {
            $rootScope.$broadcast("pdfviewer.prevPage", instance_id);
          },
          nextPage: function () {
            $rootScope.$broadcast("pdfviewer.nextPage", instance_id);
          },
          gotoPage: function (page) {
            $rootScope.$broadcast("pdfviewer.gotoPage", instance_id, page);
          },
        };
      };

      return svc;
    },
  ]);
